<!DOCTYPE html>

<!--
     ██╗ ██████╗ ██╗███╗   ██╗    ██████╗ ██╗   ██╗████████╗███████╗     ██████╗██╗     ██╗   ██╗██████╗ ██╗
     ██║██╔═══██╗██║████╗  ██║    ██╔══██╗╚██╗ ██╔╝╚══██╔══╝██╔════╝    ██╔════╝██║     ██║   ██║██╔══██╗██║
     ██║██║   ██║██║██╔██╗ ██║    ██████╔╝ ╚████╔╝    ██║   █████╗      ██║     ██║     ██║   ██║██████╔╝██║
██   ██║██║   ██║██║██║╚██╗██║    ██╔══██╗  ╚██╔╝     ██║   ██╔══╝      ██║     ██║     ██║   ██║██╔══██╗╚═╝
╚█████╔╝╚██████╔╝██║██║ ╚████║    ██████╔╝   ██║      ██║   ███████╗    ╚██████╗███████╗╚██████╔╝██████╔╝██╗
 ╚════╝  ╚═════╝ ╚═╝╚═╝  ╚═══╝    ╚═════╝    ╚═╝      ╚═╝   ╚══════╝     ╚═════╝╚══════╝ ╚═════╝ ╚═════╝ ╚═╝
-->

<html>
	<head>
		<title>MUSTANG MATCH</title>
		
		<meta charset="utf-8">
    		<meta name="Description" content="The Mundelein High School Valentine's Day Matchmaking Program">

		<link href='http://fonts.googleapis.com/css?family=Qwigley' rel='stylesheet' type='text/css'>
		<link href='css/match.css' rel='stylesheet' type='text/css'>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	</head>
	
	<body>
		<!-- upper heading -->
		<div class="stitched h1_height">
			<h1> Mustang Match </h1>
		</div>
		
		<!-- login area -->
		<div class="stitched margin_twenty">
			<div class="above_xmas">
				<p>Login to get your matches!</p>
				
				<form>
					<table>
						<tr>
							<td>Student ID:</td>
							<td><input id="username" type="number" onkeydown="if (event.keyCode == 13) document.getElementById('btn_submit').click()" placeholder="140123"></td>	
						</tr>
						<tr>
							<td>Password:</td>
							<td><input id="password" type="password"  onkeydown="if (event.keyCode == 13) document.getElementById('btn_submit').click()" placeholder="Blank = 1 Match"></td>
						</tr>
					</table>
					
					<button id="btn_submit" type="button" onclick="buttonClick()">Submit</button>
				</form>
				<br>
			</div>
			<br><br><br><br><br><br>
		</div>
		
		<!-- info -->
		<!-- we need to see if we still want to do this as a fundraiser this year.
		anybody want to work the table for all of these!? -->
		<div class="stitched info">
			Swing by our table during lunch for the <b>free </b> <i>Pacchetto Amore</i> package: three matches
			<br>$1 for the <i>Cupid's Quiver</i> package: ten matches and 5 best friends
			<br>$5 or come to Byte Club this week (Tuesday after school in Mr. Sethna's room) for the <i>Venus Deluxe</i> package: twenty matches, ten best friends, your worst friend, and your worst match PLUS extra statistics.
			<br>
			<br>Note: Your best match probably won't have you as their best match. $5 or a stay with the Byte Club will let you know.
		</div>
		
		<!-- result area -->
		<div class="stitched data">
			<!-- Best matches -->
			<h2 class="matches_heading">Your match(es) are...</h2>
			<h1 class="match_result"></h1>
			<h4 class="match_result"></h4>
			<h4 class="match_result"></h4>
			<h4 class="match_result"></h4>
			<h4 class="match_result"></h4>
			<h4 class="match_result"></h4>
			<h4 class="match_result"></h4>
			<h4 class="match_result"></h4>
			<h4 class="match_result"></h4>
			<h4 class="match_result"></h4>
			<h4 class="match_result"></h4>
			<h4 class="match_result"></h4>
			<h4 class="match_result"></h4>
			<h4 class="match_result"></h4>
			<h4 class="match_result"></h4>
			<h4 class="match_result"></h4>
			<h4 class="match_result"></h4>
			<h4 class="match_result"></h4>
			<h4 class="match_result"></h4>
			<h4 class="match_result"></h4>
			
			<!-- Best friends -->
			<h2 class="friends_heading" style="display: none;">Your best friends are...</h2>
			<h1 class="friend_result"></h1>
			<h4 class="friend_result"></h4>
			<h4 class="friend_result"></h4>
			<h4 class="friend_result"></h4>
			<h4 class="friend_result"></h4>
			<h4 class="friend_result"></h4>
			<h4 class="friend_result"></h4>
			<h4 class="friend_result"></h4>
			<h4 class="friend_result"></h4>
			<h4 class="friend_result"></h4>
			
			<!-- worst match -->
			<h2 class="worst_heading" style="display: none;">Your worst matches are...</h2>
			<h4 class="worst_match"></h4>
			<h4 class="worst_friend"></h4>
			
			<br>
			<p id="whats_next" class="above_xmas" style="display: none;">Got your matches? <a class="underline" href="https://www.khanacademy.org/computer-programming/match-making/6693548083380224">Get a bae pen name</a> or <a class="underline" href="http://www.randomlists.com/random-songs">find your song</a>!</p>
			<br><br>
		</div>

		<canvas id="xmas"></canvas>
		<!-- for passwords -->		
		<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/md5.js"></script>
		<!-- javascript for matchmaking -->
		<script type="text/javascript">
/**** Called when button is clicked ****/

var buttonClick = function() {
	var user, pass, text, person;
	
	// Get the value of the input fields with id="username", id="password"
	user = document.getElementById("username").value;
	pass = document.getElementById("password").value;
	
	// get username/pass hash
	var hash = CryptoJS.MD5(user).toString();
	
	// if the pass is in the hash, they're funded for seeing extra matches
	var fund = hash.indexOf(pass);
	
	// but passes that aren't 5 chars long throw things off
	if(pass.length !== 5) {
		fund = -1;
	}
	
	// check if username is valid
	if(user.length != 6 || !isNormalInteger(user)) {
		return;
	}
	
	// gets person's Person object
	person = getPersonFromID(user);
	
	if(person === null) {
		$('.info')[0].innerHTML = "ID invalid: Did you fill out the survey? If you did, we may not have refreshed survey data since that time. You can reach out to 170478" + "@students.d120.org and/or 160092@students.d120.org<br><br>" + $('.info')[0].innerHTML;
		return;
	}
	
	if(person.agreeToTerms.indexOf("Yes") === -1) {
		$('.info')[0].innerHTML = "Did not agree to terms. Email 170478" + "@students.d120.org and/or 190002@students.d120.org if you'd like to change that.<br><br>" + $('.info')[0].innerHTML;
		return;
	}
	
	// nothing's broken yet? display links to get a pen name and song
	$('#whats_next').show(200);
	
	
	var matchArr = person.getMatchList(LOOKING_FOR_A_MATCH);
	var friendArr = person.getMatchList(LOOKING_FOR_A_FRIEND);
	
	var came_by = fund === 0 || fund === 5 || fund === 10;
	var funded_ten = fund === 5 || fund === 10;
	var funded_all = fund === 10;
	
	
	// change headings based on funds
	if(came_by) {
		$('.matches_heading')[0].innerText = "Your matches are...";
	} else {
		$('.matches_heading')[0].innerText = "Your #1 match is...";
	}
	
	if(funded_ten) {
		$('.friends_heading').show(100);
	}
	
	if(funded_all) {
		$('.matches_heading')[0].innerText = "Your matches are...  stats key: [other person's lowest %, median %, highest %]";
		
		$('.worst_heading').show(100);
	}
	
	
	// display best matches
	var best_match_headers = $('.match_result');
	for(var i = 0; i < best_match_headers.length; i++) {
		var header = best_match_headers[i];
		var name = matchArr[i][1]; // matchArr[i][1] is the i'ths person's name
		var stats = matchArr[i][0]; //matchArr[i][1] is the i'ths person's score
		stats = Math.floor(stats/105 * 100); // best match at time of comment = 102.9
		
		if(i === 0) {
			header.innerText = name; // set h element to match's name
			if(funded_ten) {
				header.innerText = name + " is a " + stats + "% match";
			}
			if(funded_all) {
				header.innerText = getMatchStatsString(person, matchArr[i][2], LOOKING_FOR_A_MATCH);
			}
		}
		else if(i <= 2 && came_by) {
			header.innerText = name;
			if(funded_ten){
				header.innerText = name + " is a " + stats + "% match";
			}
			if(funded_all) {
				header.innerText = getMatchStatsString(person, matchArr[i][2], LOOKING_FOR_A_MATCH);
			}
		}
		else if(i <= 9 && funded_ten) {
			header.innerText = name + " is a " + stats + "% match";
			
			if(funded_all) {
				header.innerText = getMatchStatsString(person, matchArr[i][2], LOOKING_FOR_A_MATCH);
			}
		}
		else if(i <= 19 && funded_all) {
			header.innerText = getMatchStatsString(person, matchArr[i][2], LOOKING_FOR_A_MATCH);
		}
	}
	
	// display best friends
	var best_friend_headers = $('.friend_result');
	for(var i = 0; i < best_friend_headers.length; i++) {
		var header = best_friend_headers[i];
		var name = friendArr[i][1];
		var stats = friendArr[i][0];
		stats = Math.floor(stats/80 * 100); // best at time of comment 78.6
		
		
		if(i <= 4 && funded_ten) {
			header.innerText = name + " is a " + stats + "% friend";
			
			if(funded_all) {
				header.innerText = getMatchStatsString(person, friendArr[i][2], LOOKING_FOR_A_FRIEND);
			}
		}
		else if(i <= 9 && funded_all) {
			header.innerText = getMatchStatsString(person, friendArr[i][2], LOOKING_FOR_A_FRIEND);
		}
	}
	
	// display worst friend/match
	if(funded_all) {
		var worst_match_header = $('.worst_match')[0];
		var worst_friend_header = $('.worst_friend')[0];
		
		worst_match_header.innerText = getMatchStatsString(person, matchArr[matchArr.length - 1][2], LOOKING_FOR_A_MATCH);
		worst_friend_header.innerText = getMatchStatsString(person, friendArr[friendArr.length - 1][2], LOOKING_FOR_A_FRIEND);
	}
}

var getMatchStatsString = function(person, other, lookingForFriend) {
	var max_score = lookingForFriend? 80 : 105;
	/* 
	// for finding the max score:
	
	logging = false;
	var a = [];
	for(var i = 0; i < people.length; i++) {
	 if(people[i])
	   a.push(people[i].getMatchList(true)[0][0]);
	}
	a.sort(function(a, b){return b - a;});
	console.log(a);
	*/
	
	var stat = person.matchNumber(other, lookingForFriend) / max_score * 100;
	    stat = Math.round(stat);
	var other_stat = other.matchNumber(person, lookingForFriend) / max_score * 100;
	    other_stat = Math.round(other_stat);
	var other_list = other.getMatchList(lookingForFriend);
	
	// find this person's position in other person's list
	var pos = -1;
	for(var i = 0; i < other_list.length; i++) {
		if(other_list[i][2] === undefined) {
			continue;
		}
		
		if(other_list[i][2].username === person.username) {
			pos = i+1;
			break;
		}
	}
	
	var other_highest = other_list[0][0] / max_score * 100;
	    other_highest = Math.round(other_highest);
	var other_med = other_list[Math.floor(other_list.length/2)][0] / max_score * 100;
	    other_med = Math.round(other_med);
	var other_lowest = other_list[other_list.length - 1][0] / max_score * 100;
	    other_lowest = Math.round(other_lowest);
	
	var type = lookingForFriend ? "friend" : "match";
	
	return other.name + " is a " + stat + "% " + type + ", they matched you " + other_stat + "%. You're their #" + pos + "/" + other_list.length + " match. [" + other_lowest + ", " + other_med + ", " + other_highest + "]";
};

// returns whether a string is an integer > 0
// might not work with 0 or 1 index-long non-integer strings
var isNormalInteger = function(str) {
	var n = ~~Number(str);
	return String(n) === str && n >= 0;
};


/**** Called when document finishes loading ****/

$(document).ready(function(){
  getPeople();
  console.log('executed getpeople');
});

// called when the document is loaded, downloads the match responses list
// and creates the people array from it
//verified working 1/30/16 by Farmer
var getPeople = function() {
	$.get( "/matchresponses.csv", function( data ) {
		//$( ".data" ).html( data );
		
		var lines = data.split("\n");
		
		for(var i = 0; i < lines.length; i++) {
			people.push(new Person(lines[i]));
		}
		
		console.log(people);
	});
};


/**** Code for Person object/people array ****/

// Person array, holds all survey responses
var people = [];

// a Person object holds each person's responses in a single object
// and provides methods to go along with it (matchNumber and getMatchList)
//Data field assignment
var Person = function(line) {
	line = line.split(',');
	
//Each question separated
	
	this.username = line[1];
	
	this.name = line[2];
	
	this.ID = line[3];
	
	this.gender = line[4];
	
	this.genderPref = line[5];
	
	this.grade = line[6];
	
	this.eyeColor = line[7];
	
	this.height = line[8];
	
	//Favorite trait
	this.face = parseInt(line[9],10);
	this.eyes = parseInt(line[90],10);
	this.smile = parseInt(line[91],10);
	this.hair = parseInt(line[92],10);
	this.physique = parseInt(line[94],10);
	
	//!!! This field is separated by commas which will jack everything up!
	this.uniqueFeatures = line[93];
	
	//line[38] to [40] unused in the survey, for some reason
	this.extrovertIntrovert = parseInt(line[37],10);
	
	//Favorite Subject
	this.math = parseInt(line[79],10);
	this.science = parseInt(line[80],10);
	this.gym = parseInt(line[81],10);
	this.socialStudies = parseInt(line[82],10);
	this.english = parseInt(line[83],10);
	this.art = parseInt(line[84],10);
	this.languages = parseInt(line[95],10);
	this.other = parseInt(line[121],10);
	
	//Favorite Season
	this.summer = parseInt(line[85],10);
	this.spring = parseInt(line[86],10);
	this.winter = parseInt(line[87],10);
	this.fall = parseInt(line[88],10);
	
	//Favorite Color
	this.redColor = parseInt(line[63],10);
	this.orangeColor = parseInt(line[64],10);
	this.yellowColor = parseInt(line[65],10);
	this.greenColor = parseInt(line[66],10);
	this.blueColor = parseInt(line[67],10);
	this.purpleColor = parseInt(line[68],10);
	this.pinkColor = parseInt(line[69],10);
	this.otherColor = parseInt(line[122],10);
	
	
	//Favorite Restaurant
	this.chipotle = parseInt(line[55],10);
	this.panera = parseInt(line[56],10);
	this.luke = parseInt(line[57],10);
	this.chinaBuffet = parseInt(line[58],10);
	this.iHOP = parseInt(line[59],10);
	this.fastFood = parseInt(line[60],10);
	this.maggiano = parseInt(line[61],10);
	//line[62] unused
	//Favorite Date
	this.netflix = parseInt(line[20],10);
	this.beach = parseInt(line[21],10);
	this.iceCream = parseInt(line[22],10);
	this.movies = parseInt(line[23],10);
	this.rockClimbing = parseInt(line[24],10);
	this.swim = parseInt(line[25],10);
	this.walk = parseInt(line[26],10);
	this.dinner = parseInt(line[27],10);
	this.picnic = parseInt(line[28],10);
	this.zipline = parseInt(line[29],10);
	this.exercise = parseInt(line[30],10);
	
	//Your Style
	this.preppy = parseInt(line[96],10);
	this.colorBased = parseInt(line[98],10);
	this.punk = parseInt(line[100],10);
	this.boho = parseInt(line[101],10);
	this.chic = parseInt(line[102],10);
	this.laidBack = parseInt(line[105],10);
	this.glam = parseInt(line[107],10);
	this.sophisticated = parseInt(line[109],10);
	this.sporty = parseInt(line[112],10);
	
//paired questions = answerInterest 	
	
    //Favorite Traits you look for
	this.faceInterest = parseInt(line[41],10);
	this.eyesInterest = parseInt(line[42],10);
	this.smileInterest = parseInt(line[43],10);
	this.hairInterest = parseInt(line[44],10);
	this.physiqueInterest = parseInt(line[45],10);

//lines 46-49 are unused

    //Characteristics you look for
    this.intelligence = parseInt(line[31],10);
    this.humor = parseInt(line[32],10);
	this.honesty = parseInt(line[33],10);
	this.appearance = parseInt(line[34],10);
	this.compassion = parseInt(line[35],10);
	this.enthusiasm = parseInt(line[36],10);

	//Things in a Relationship you look for
	this.qualityTime = parseInt(line[15],10);
	this.physicalAffection = parseInt(line[16],10);
	this.presents = parseInt(line[17],10);
	this.talking = parseInt(line[18],10);
	this.volunteering = parseInt(line[19],10);
	this.affirmation = parseInt(line[119],10);
	
	this.heightInterest = parseInt(line[50],10);
	
	//Eye Color you look for
	this.blue = parseInt(line[10],10);
	this.green = parseInt(line[11],10);
	this.hazel = parseInt(line[12],10);
	this.gray = parseInt(line[13],10);
	this.brown = parseInt(line[14],10);
	
	//Style you look for
	this.preppyInterest = parseInt(line[123],10);
	this.colorBasedInterest = parseInt(line[124],10);
	this.punkInterest = parseInt(line[125],10);
	this.bohoInterest = parseInt(line[126],10);
	this.chicInterest = parseInt(line[127],10);
	this.laidBackInterest = parseInt(line[128],10);
	this.glamInterest = parseInt(line[129],10);
	this.sophisticatedInterest = parseInt(line[130],10);
	this.sportyInterest = parseInt(line[131],10);
	
	//Agreed to terms?
	this.agreedTerms = line[130];
	/* this.personalityVSAppearance = line[62]; // unused */
};


// constant signifying that one asked for their responses to not be used
// TODO: send emails asking if people want to change their agreeToTerms response
var TERMS_NOT_AGREED_TO = -666;

// constant signifying the response isn't a real one or is really buggy
// tested for by seeing if name is undefined
var BUGGY_PERSON = -867;

// constant signifying the people being checked are the same
var SAME_PERSON = -11;

// returns a number signifying how well someone matches with someone else
Person.prototype.matchNumber = function(other, lookingForFriend) {
	if(this.name === undefined || other.name === undefined) {
		return BUGGY_PERSON;
	}
	
	if (other.agreeToTerms.indexOf("Yes") === -1 || this.agreeToTerms.indexOf("Yes") === -1) {
		return TERMS_NOT_AGREED_TO;
	}
	
	if(other.username == this.username) {
		return SAME_PERSON;
	}
	
	if(this.grade === "Senior"){				//changing grade strings to numbers
		this.grade = 4;
	}
	if(this.grade === "Junior"){
		this.grade = 3;
	}
	if(this.grade === "Sophomore"){
		this.grade = 2;
	}
	if(this.grade === "Freshman"){
		this.grade = 1;
	}
	if(other.grade === "Senior"){
		other.grade = 4;
	}
	if(other.grade === "Junior"){
		other.grade = 3;
	}
	if(other.grade === "Sophomore"){
		other.grade = 2;
	}
	if(other.grade === "Freshman"){
		other.grade = 1;
	}

	var classScore = 0;
	var physicalScore = 0;
	var hobbyScore = 0;
	var compScore = 0;
	
	// gender possibilities = Male, Female
	// interested in possibilities = Males, Females, Both
	
	var genderCompatOther = this.gender === other.genderInterestedIn.split('s')[0] || other.genderInterestedIn === "Both";
	var genderCompatSelf = this.genderInterestedIn.split('s')[0] === other.gender || this.genderInterestedIn === "Both";
	var interestedInEachOther = genderCompatOther && genderCompatSelf;
	
	//checks if people are interested in each other or if this is a friend search (gender unimportant)
	if((interestedInEachOther && !lookingForFriend) || (!interestedInEachOther && lookingForFriend)){ // checking for gender preferences		 
		
		var abs = Math.abs;
		
		// class score
		classScore = 4-abs(this.grade-other.grade);
		
		/** physical Qs **/

		// hair color
		if (this.hairColorPreference === other.hairColor){
			physicalScore += 2;
		} else if (this.hairColorPreference === "I have no preference"){
			physicalScore += 0.2;
		}

		// eye color
		if (this.eyeColorPreference === other.eyeColor){
			physicalScore += 2;
		} else if (this.eyeColorPreference === "I have no preference"){
			physicalScore += 0.2;
		}

		// height
		if (this.heightColorPreference === other.height){
			physicalScore += 2;
		} else if (this.heightColorPreference === "I have no preference"){
			physicalScore += 0.2;
		}


	/*	// friday night
		if (this.fridayNight === other.fridayNight) {
			hobbyScore += 1;
		}

		
		
		if(lookingForFriend) {
			physicalScore = 0;
		}

		compScore = classScore + physicalScore; // + hobbyScore	//total compatibility score
	}


	return compScore;*/
	}
};

// used with getMatchList and matchNumber
// lets function know if looking for someone that fits your gender preferences (match)
// or someone that doesn't (friend)
var LOOKING_FOR_A_FRIEND = true;
var LOOKING_FOR_A_MATCH = false;

/** Can disable logging if needed **/
var logging = false;

// returns an list with best matches at the front and worst at the back
// returns [match, name, person, people[] index] array
// TODO: lists of more than best match, e.g. best fiend, people who matched best with you
Person.prototype.getMatchList = function(lookingForFriend) {
	var scoreArr = [];
	
	// get array of match numbers
	for(var r = 0; r < people.length; r++) {
	  var other = people[r];
	  var match_num = this.matchNumber(other, lookingForFriend);
	  
	  var arr = [match_num, other.name, other,  "person #" + r];
	  
	  if(match_num > 0) {
	  	scoreArr.push(arr);
	  }
	}
	
	// this person is buggy
	if(scoreArr.length === 0) {
		return [BUGGY_PERSON, "BUGGY PERSON", people[0], "person# " + 0];
	}
	
	// sort the array
	scoreArr.sort(function(a, b){return b[0]-a[0]});
	
	// log the array and best match
	if(logging) {
		console.log(scoreArr);
		console.log("best match: " + scoreArr[0][1]);
	}
	
	return scoreArr;
};

// gets an ID's Person object160095
// assumes properly formatted ID
var getPersonFromID = function(id) {
    logging = true;
	for(var i = 1; i < people.length - 1; i++) {
	  	if(people[i].username.split('@')[1] == id) {
	    		if(logging) {
	    			console.log('found! response#' + i);
	    		}
	    		return people[i];
	  	}
	}
	return null;
};

		</script>
		<!-- heart snow code -->
		<script src="js/letitsnow.js"></script>
	</body>
</html>
